<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <title>PDF Export Tool</title>

    <!-- html2pdf.js import -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- Google Fonts (example set) -->

    <link href="https://fonts.googleapis.com/css2?family=Roboto&family=Open+Sans&family=Merriweather&family=Inconsolata&display=swap"
          rel="stylesheet">

    <!-- Choices.js CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"/>

    <style>
        body {
            font-family: sans-serif;
            background-color: #f8f8f8;
            margin: 2em;
        }

        #container {
            display: flex;
            gap: 1em;
        }

        #styleControls {
            flex: 0 0 250px;
            padding: .5em;
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 0.5em;
        }

        #fontSizeInput, #headerSizeInput {
            width: 3em;
        }

        .styleBlock {
            border: 1px solid #888;
            border-radius: 0.5em;
            padding: .5em;
            margin-bottom: .5em;
        }

        .styleBlock h3 {
            margin-bottom: 0.5em;
            margin-top: 0;
        }

        iframe {
            flex-grow: 1;
            height: 600px;
            border: 1px solid #ccc;
            background: #fff;
        }

        .choices {
            margin-bottom: 0;
        }
    </style>
</head>
<body>

<h1>PDF Export Tool</h1>
<div id="container">
    <script type="application/json" id="style-defaults">
        {
            "font": {
                "min": 0.5,
                "max": 3,
                "step": 0.1,
                "default": 1,
                "color": "#000000",
                "family": "sans-serif"
            },
            "header": {
                "min": 0.5,
                "max": 5,
                "step": 0.1,
                "default": 2,
                "color": "#000000",
                "family": "sans-serif"
            }
        }
    </script>

    <div id="styleControls">
        <div class="styleBlock">
            <h3>Page settings</h3>
            <label for="fontSize">Font Size: <input type="number" id="fontSizeInput"><span id="fontSizeUnit">Ã—</span></label><br/>
            <input type="range" id="fontSize"/>

            <br/><br/>
            <label for="fontFamily">Font Family:</label>
            <select id="fontFamily">
                <option value="sans-serif">Sans</option>
                <option value="serif">Serif</option>
                <option value="monospace">Monospace</option>
                <option value="'Roboto', sans-serif">Roboto</option>
                <option value="'Open Sans', sans-serif">Open Sans</option>
                <option value="'Merriweather', serif">Merriweather</option>
                <option value="'Inconsolata', monospace">Inconsolata</option>
                <!-- Add more fonts here -->
            </select>
            <br/>
            <label>Text Color: <input type="color" id="textColor"/></label>
        </div>
        <div class="styleBlock">
            <h3>Header settings</h3>
            <label for="headerSize">Font Size: <input type="number" id="headerSizeInput"><span id="headerSizeUnit">Ã—</span></label><br/>
            <input type="range" id="headerSize"/>

            <br/><br/>
            <label for="headerFamily">Font Family:</label>
            <select id="headerFamily">
                <option value="sans-serif">Sans</option>
                <option value="serif">Serif</option>
                <option value="monospace">Monospace</option>
                <option value="'Roboto', sans-serif">Roboto</option>
                <option value="'Open Sans', sans-serif">Open Sans</option>
                <option value="'Merriweather', serif">Merriweather</option>
                <option value="'Inconsolata', monospace">Inconsolata</option>
                <!-- Add more fonts here -->
            </select>
            <br/>
            <label for="headerColor">Text Color: </label>
            <input type="color" id="headerColor"/>
        </div>

        <button onclick="printPreview()">Print Preview</button>
        <button onclick="saveAsPDF()">Save as PDF</button>
        <br/><br/>
        <button id="resetStyles">Reset</button>

    </div>

    <iframe id="previewFrame"></iframe>
</div>

<script>
    let testing;

    class StyleCategory {
        constructor(name, settings) {
            Object.assign(this, { name }, settings);
        }

        clamp(value) {
            return Math.min(Math.max(value, this.min), this.max);
        }
    }

    const configData = JSON.parse(document.getElementById("style-defaults").textContent);
    let fontConfig = new StyleCategory("font", configData.font);
    let headerConfig = new StyleCategory("header", configData.header);

    const frame = document.getElementById("previewFrame");
    window.onload = () => {
        frame.src = "Large HTML page with images.html";
        frame.onload = () => {
            injectStyleSheet();
        };

    };
    function injectStyleSheet() {
        const doc = frame.contentDocument || frame.contentWindow.document;

        // Add the style tag if it doesn't exist
        if (!doc.getElementById("dynamic-style")) {
            const style = doc.createElement("style");
            style.id = "dynamic-style";
            style.setAttribute("data-style-marker", "dynamic")
            doc.head.appendChild(style);

        }


        // Inject Google Fonts

        if (!doc.getElementById("google-fonts")) {
            const link = doc.createElement("link");
            link.id = "google-fonts";
            link.rel = "stylesheet";
            link.href = "https://fonts.googleapis.com/css2?family=Roboto&family=Open+Sans&family=Merriweather&family=Inconsolata&display=swap";
            link.onload = setupStyleControls; // ðŸŸ¢ Wait for fonts to load
            doc.head.appendChild(link);
        } else {
            setupStyleControls(); // Fonts already there
        }
    }

    function findStyleSheetWithMarker(doc) {
        for (let i = 0; i < doc.styleSheets.length; i++) {
            const sheet = doc.styleSheets[i];
            try {
                if (sheet.ownerNode?.getAttribute("data-style-marker") === "dynamic") {
                    return sheet;
                }
            } catch (e) {
                console.warn("Could not access stylesheet:", sheet.href, e);
            }
        }
        return null;
    }

    function setupStyleControls() {
        const doc = frame.contentDocument || frame.contentWindow.document;

        const fontSize = document.getElementById("fontSize");
        const fontSizeInput = document.getElementById("fontSizeInput");
        const fontFamily = document.getElementById("fontFamily");
        const textColor = document.getElementById("textColor");

        const headerSize = document.getElementById("headerSize");
        const headerSizeInput = document.getElementById("headerSizeInput");
        const headerFamily = document.getElementById("headerFamily");
        const headerColor = document.getElementById("headerColor");

        // Font size range + input
        fontSize.min = fontConfig.min;
        fontSize.max = fontConfig.max;
        fontSize.step = fontConfig.step;
        fontSize.value = fontConfig.default;
        fontSizeInput.min = fontConfig.min;
        fontSizeInput.max = fontConfig.max;
        fontSizeInput.step = fontConfig.step;
        fontSizeInput.value = fontConfig.default;

        // Header size range + input
        headerSize.min = headerConfig.min;
        headerSize.max = headerConfig.max;
        headerSize.step = headerConfig.step;
        headerSize.value = headerConfig.default;
        headerSizeInput.min = headerConfig.min;
        headerSizeInput.max = headerConfig.max;
        headerSizeInput.step = headerConfig.step;
        headerSizeInput.value = headerConfig.default;

        // Colors
        textColor.value = fontConfig.color;
        headerColor.value = headerConfig.color;

        // Font families (dropdowns)
        fontFamilyChoices.setChoiceByValue(fontConfig.family);
        headerFamilyChoices.setChoiceByValue(headerConfig.family);

        const applyStyles = () => {

            const style = doc.getElementById("dynamic-style");
            style.textContent = `
        body {
          font-size: ${fontSize.value}em;
          font-family: ${fontFamily.value};
          color: ${textColor.value};
        }

        h1 {
          font-size: ${headerSize.value}em;
          font-family: ${headerFamily.value};
          color: ${headerColor.value};
        }`;
        };

        const updateStyle = () => {
            applyStyles();
        }

        function resetStyleControls() {
            fontSize.value = fontConfig.default;
            fontSizeInput.value = fontConfig.default;
            headerSize.value = headerConfig.default;
            headerSizeInput.value = headerConfig.default;
            textColor.value = fontConfig.color;
            headerColor.value = headerConfig.color;

            fontFamilyChoices.setChoiceByValue(fontConfig.family);
            headerFamilyChoices.setChoiceByValue(headerConfig.family);

            updateStyle();
        }

        document.getElementById("resetStyles").addEventListener("click", resetStyleControls);

        fontSize.addEventListener("input", () => {
            fontSizeInput.value = fontSize.value;
            updateStyle();
        });
        fontSizeInput.addEventListener("change", () => {
            fontSizeInput.value = fontConfig.clamp(parseFloat(fontSizeInput.value));
            fontSize.value = fontSizeInput.value;
            updateStyle();
        });
        textColor.addEventListener("input", updateStyle);
        fontFamily.addEventListener("change", updateStyle);

        headerSize.addEventListener("input", () => {
            headerSizeInput.value = headerSize.value;
            updateStyle();
        });
        headerSizeInput.addEventListener("change", () => {
            headerSizeInput.value = headerConfig.clamp(parseFloat(headerSizeInput.value));
            headerSize.value = headerSizeInput.value;
            updateStyle();
        });
        headerColor.addEventListener("input", updateStyle);
        headerFamily.addEventListener("change", updateStyle);
    }

    function printPreview() {
        frame.contentWindow.focus();
        frame.contentWindow.print();
    }

    function saveAsPDF() {
        const srcDoc = frame.contentDocument || frame.contentWindow.document;
        const clonedDoc = srcDoc.documentElement.cloneNode(true);

        // Create a new print window
        const printWindow = window.open('', '_blank', 'width=800,height=600');

        if (!printWindow) {
            alert("Popup blocked. Please allow popups for this site.");
            return;
        }

        const printDoc = printWindow.document;
        printDoc.open();
        printDoc.write('<!DOCTYPE html><html lang="en"><head><title>Print Preview</title>');

        // Include any necessary stylesheets here
        const dynamicStyle = srcDoc.getElementById("dynamic-style");
        if (dynamicStyle) {
            printDoc.write(`<style>${dynamicStyle.textContent}</style>`);
        }

        // Optional: Add a print-specific style
        printDoc.write(`
        <style>
            @media print {
                body {
                    margin: 1in;
                }
            }
        </style>
    `);

        printDoc.write('</head><body>');
        printDoc.write(clonedDoc.querySelector('body').innerHTML);
        printDoc.write('</body></html>');
        printDoc.close();

        // Give it a moment to render
        printWindow.onload = () => {
            printWindow.focus();
            printWindow.print();
        };
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
<script>
    // Declare in global scope
    let fontFamilyChoices;
    let headerFamilyChoices;

    document.addEventListener("DOMContentLoaded", function () {
        fontFamilyChoices = new Choices("#fontFamily", {
            searchEnabled: true,
            itemSelectText: "",
            shouldSort: true
        });

        headerFamilyChoices = new Choices("#headerFamily", {
            searchEnabled: true,
            itemSelectText: "",
            shouldSort: true
        });
    });
</script>

</body>
</html>
